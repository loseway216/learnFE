<template>
  <div class="wrapper">
    <div id="map" ref="map"></div>
    <div class="summary">
      <div class="item">
        <span class="name">已接入工厂数量: </span><span class="value">?</span>
      </div>
      <div class="item">
        <span class="name">供应商数量: </span><span class="value">?</span>
      </div>
    </div>
    <img :src="gif" alt="gif" class="gif" />
  </div>
</template>

<script setup>
import gif from "@/assets/images/map_background.gif";
import chinaJson from "@/assets/map/china.json";
import { mapCoords, mapOptions } from "@/utils/map.js";
import { onBeforeUnmount, onMounted, ref } from "vue";
import { useRouter } from "vue-router";

const router = useRouter();
const map = ref(null);
let mapChart = null;
// 地图配置
const options = mapOptions;
const geoData = [
  {
    source: "天津",
    destination: "长宁",
    counts: 10,
  },
  {
    source: "襄阳",
    destination: "长宁",
    counts: 2,
  },
  {
    source: "南京",
    destination: "长宁",
    counts: 3,
  },
  {
    source: "青浦",
    destination: "长宁",
    counts: 3,
  },
];
geoData.forEach(({ source, destination, counts, color, sum }) => {
  const coordsFrom = mapCoords[source] || [0, 0];
  const coordsTo = mapCoords[destination] || [0, 0];
  const result = {
    fromName: source,
    toName: destination,
    from: "中国" + "##" + source,
    to: "中国" + "##" + destination,
    coords: [coordsFrom, coordsTo],
    details: counts,
    // color
  };

  // 尾迹
  options.series[0].data.push(result);
  options.series[1].data = options.series[0].data;
  options.series[2].data.push({
    // 涟漪（终点）
    name: destination,
    value: coordsTo.concat(color),
    counts,
    color,
    sum,
  });
  options.series[3].data.push({
    // 散点（起点）
    name: source,
    value: coordsFrom,
    symbolSize: 2,
  });
});

onMounted(() => {
  mapChart = echarts.init(map.value);
  echarts.registerMap("china", chinaJson);
  mapChart.setOption(options, false);
  window.addEventListener("resize", () => mapChart.resize());
  mapChart.on("click", (event) => {
    // TODO: 哪些市
    const citys = ["长宁"];
    if (event.componentType === "geo" && citys.includes(event.name)) {
      router.push(`/topo/${event.name}`);
    }
    if (
      event.componentSubType === "effectScatter" &&
      citys.includes(event.data.name)
    ) {
      router.push(`/topo/${event.data.name}`);
    }
  });
});

onBeforeUnmount(() => {
  if (mapChart) {
    window.removeEventListener("resize", () => mapChart.resize());
    mapChart.clear();
    mapChart.dispose();
  }
});
</script>

<style scoped>
.wrapper {
  width: 100%;
  height: 100%;
  position: relative;
}

#map {
  width: 100%;
  height: 100%;
  /* background-image: url(../assets/images/map_background.gif) bottom/contain
    no-repeat content-box border-box; */
  z-index: 2;
}

.summary {
  position: absolute;
  left: 45%;
  top: 10%;
  font-size: 20px;
  font-weight: 500;
  border: 1px solid rgba(51, 102, 255, 0.55);
  box-shadow: inset 17px 0 15px -15px rgb(51 102 255 / 55%),
    inset -15px 0 17px -15px rgb(51 102 255 / 55%);
  padding: 20px;
  color: #00ffe4;
}

.name {
  display: inline-block;
  width: 180px;
}

.gif {
  position: absolute;
  bottom: 0;
  right: 0;
  z-index: 1;
}
</style>
